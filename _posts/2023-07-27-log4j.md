---
title:  "log4j 漏洞"
categories: 
  - 漏洞分析
---
对应CVE-2021-44228

漏洞在12月10号暴出来：打印的日志含有jndi lookup 表达式，即被解析
> In Apache Log4j2 versions up to and including 2.14.1 (excluding security releases 2.3.1, 2.12.2 and 2.12.3), the JNDI features used in configurations, log messages, and parameters do not protect against attacker-controlled LDAP and other JNDI related endpoints. An attacker who can control log messages or log message parameters can execute arbitrary code loaded from LDAP servers when message lookup substitution is enabled.

12月4号官方库有提交，限制了JNDI访问：https://github.com/apache/logging-log4j2/commit/c77b3cb39312b83b053d23a2158b99ac7de44dd3

之后又发现其他利用方式，cve-2021-45046: 日志pattern中含有context lookup
> When the logging configuration uses a non-default Pattern Layout with a Context Lookup (for example, $${ctx:loginId}),attackers with control over Thread Context Map (MDC) input data can craft malicious input data using a JNDI Lookup pattern, resulting in an information leak and remote code execution in some environments and local code execution in all environments

12月12号默认关闭了JNDI： https://github.com/apache/logging-log4j2/commit/c362aff473e9812798ff8f25f30a2619996605d5

12月13号将message lookup功能彻底删除：https://github.com/apache/logging-log4j2/commit/27972043b76c9645476f561c5adc483dec6d3f5d

> Log4j 2.16.0 fixes this issue by removing support for message lookup patterns and disabling JNDI functionality by default. This issue can be mitigated in prior releases (< 2.16.0) by removing the JndiLookup class from the classpath (example: zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class).
>
> Log4j 2.15.0 restricts JNDI LDAP lookups to localhost by default. Note that previous mitigations involving configuration such as to set the system property log4j2.formatMsgNoLookups to true do NOT mitigate this specific vulnerability.

后续对其他地方的JNDI使用也做了限制
- https://github.com/apache/logging-log4j2/commit/ab2fb451d248702880a231646dace6b3ec9d98c2
- https://github.com/apache/logging-log4j2/commit/be97ee03cd5081b66b28c029fb3b10d3ce57b1f8
- https://github.com/apache/logging-log4j2/commit/80eaa5cdaef536c2163aa3a230ddaee24e03a4ff
- https://github.com/apache/logging-log4j2/commit/8e18c130c7094b12138d7fab6b91bd8701ff00ee

[log4j安全官网](https://logging.apache.org/log4j/2.x/security.html)

[java JNDI 的解释](https://tttang.com/archive/1611/)
> 由于JNDI注入动态加载的原理是使用Reference引用Object Factory类，其内部在上文中也分析到了使用的是URLClassLoader，所以不受java.rmi.server.useCodebaseOnly=false属性的限制。
> 但是不可避免的受到 com.sun.jndi.rmi.object.trustURLCodebase、com.sun.jndi.cosnaming.object.trustURLCodebase的限制。
>
> 所以，JNDI-RMI注入方式有： * codebase(JDK 6u132、7u122、8u113之前可以) * 利用本地Class Factory作为Reference Factory
>
> JNDI-LDAP注入方式： * codebase(JDK 11.0.1、8u191、7u201、6u211之前可以) * serialize（两个切入点）
